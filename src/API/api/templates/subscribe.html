<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>[TEST] Subscribe to notifications</title>
        <script>
            function askPermission() {
                return new Promise(function (resolve, reject) {
                    const permissionResult = Notification.requestPermission(function (result) {
                        resolve(result);
                    });

                    if (permissionResult) {
                        permissionResult.then(resolve, reject);
                    }
                }).then(function (permissionResult) {
                    if (permissionResult !== 'granted') {
                        throw new Error("We weren't granted permission.");
                    }
                });
            }

            const pubkey = 'BIuFYQ2xzOaYgq5kHds1WieS8ccvDcvnLot3OHuje-ZzMz4WbiCc0p_1MhIHWLLRZBsebfHPVkk4ixfW9Kwlh9Y';

            function urlBase64ToUint8Array(base64String) {
                const padding = '='.repeat((4 - base64String.length % 4) % 4);
                const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
                const rawData = window.atob(base64);
                const outputArray = new Uint8Array(rawData.length);
                for (let i = 0; i < rawData.length; ++i) {
                    outputArray[i] = rawData.charCodeAt(i);
                }
                return outputArray;
            }

            function subscribeUser() {
                return navigator.serviceWorker
                    .register('../static/js/service-worker.js')
                    .then(function (registration) {
                        const subscribeOptions = {
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(pubkey)
                        };

                        return registration.pushManager.subscribe(subscribeOptions);
                    })
                    .then(function (pushSubscription) {
                        console.log(
                            'Received PushSubscription: ',
                            JSON.stringify(pushSubscription),
                        );
                        fetch('/subscribe-pushnotify', {
                            method: 'POST',
                            body: JSON.stringify({
                                username: 'someone',
                                subscription: JSON.stringify(pushSubscription)
                            }),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        return pushSubscription;
                    });
            }
        </script>
    </head>
    <body>
        <button onclick="askPermission(); subscribeUser()">Click me to subskrybe</button>
    </body>
</html>